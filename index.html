<!DOCTYPE html>
<html>
  <head>
    <title>Stata ETABLE Format App</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style>
/* sheetjs.css (C) 2014-present SheetJS -- http://sheetjs.com */
/* vim: set ts=2: */
html {
  overflow: hidden;
}
#drop{
  border:2px dashed #bbb;
  -moz-border-radius:5px;
  -webkit-border-radius:5px;
  border-radius:5px;
  padding:25px;
  text-align:center;
  width:128px;
  font:20pt bold,"Vollkorn";color:#bbb
}

#left {
  width:188px;
  position:absolute;
  left:0;
}
#right {
  position:absolute;
  left:200px;
}
#logo {
  padding:25px;
}
#header {
  height:168px;
}
#grid {
  height: 100px;
  display: none;
}

.winpt { width:98%; }
.success { color: #468847; }
.error { color: #b94a48; }
.info { color: #3a87ad; }
pre { white-space: pre-wrap; }
</style>

  </head>
  <body>
    <script src="//unpkg.com/canvas-datagrid/dist/canvas-datagrid.js"></script>

<!--     <link rel="stylesheet" media="screen" href="assets/vendor/samples.css"> -->

    <div id="body">
      <div id="left">
      <div id="drop">Drop a file here</div>
      <input type="file" id="file" value=""/><label for="file">... or click here to select a file</label>
      <h3>Choose a worksheet:</h3>
      <div id="buttons"></div>
    </div>
    <div id="right">
      <div id="header">
        <pre id="out"></pre>
        <h2>SheetJS In-Browser Live Grid Demo</h2>
        <h3>
          Drop a spreadsheet in the box to the left to see a preview.<br/>
          Need a file?  Why not the <a href="https://obamawhitehouse.archives.gov/sites/default/files/omb/budget/fy2014/assets/receipts.xls" rel="nofollow noreferrer">OMB FY 2014 Federal Receipts?</a>
        </h3>
        <table id="tt">
          <tr><td><a href="https://sheetjs.com">SheetJS (Parsing Library)</a></td></tr>
          <tr><td><a href="https://canvas-datagrid.js.org" rel="nofollow noreferrer">Canvas DataGrid (Grid Library)</a></td></tr>
        </table>
      </div>
      <div id="grid"></div>
      <div id="footnote">
        <h3>
          This particular parser assumes that <b>the first row of the table is a header.</b><br/>
          For parsing a more general file, check the Interactive Demos
        </h3><br/>
        <h3>The entire process occurs within your browser <br />
          <b>NO SPREADSHEET DATA IS SENT TO ANY SERVER (parsing and rendering done in your browser)</b></br>
        <h3>This is a work in progress.  Every bit helps.  Please report issues to <a href="https://git.sheetjs.com/sheetjs/sheetjs/issues/" rel="nofollow noreferrer">our bug tracker.</a>
        <h3>Follow us on Twitter <a href="https://twitter.com/SheetJS" rel="nofollow noreferrer">@SheetJS</a></h3>
      </div>
    </div>

    <script src="//cdn.sheetjs.com/xlsx-latest/package/dist/shim.min.js"></script>
    <script src="//cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script>
    /* oss.sheetjs.com (C) 2014-present SheetJS -- http://sheetjs.com */
/* vim: set ts=2: */

var DropSheet = function DropSheet(opts) {
  if(!opts) opts = {};
  var nullfunc = function(){};
  if(!opts.errors) opts.errors = {};
  if(!opts.errors.badfile) opts.errors.badfile = nullfunc;
  if(!opts.errors.pending) opts.errors.pending = nullfunc;
  if(!opts.errors.failed) opts.errors.failed = nullfunc;
  if(!opts.errors.large) opts.errors.large = nullfunc;
  if(!opts.on) opts.on = {};
  if(!opts.on.workstart) opts.on.workstart = nullfunc;
  if(!opts.on.workend) opts.on.workend = nullfunc;
  if(!opts.on.sheet) opts.on.sheet = nullfunc;
  if(!opts.on.wb) opts.on.wb = nullfunc;

  var useworker = typeof Worker !== 'undefined';
  var pending = false;

  function sheetjsw(data, cb, readtype) {
    pending = true;
    opts.on.workstart();
    var scripts = document.getElementsByTagName('script');
    var dropsheetPath;
    for (var i = 0; i < scripts.length; i++) {
      if (scripts[i].src.indexOf('dropsheet') != -1) {
        dropsheetPath = scripts[i].src.split('dropsheet')[0];
      }
    }
    var worker = new Worker(dropsheetPath + 'sheetjsw.js');
    worker.onmessage = function(e) {
      switch(e.data.t) {
        case 'ready': break;
        case 'e': pending = false; console.error(e.data.d); break;
        case 'xlsx':
          pending = false;
          opts.on.workend();
          cb(JSON.parse(e.data.d)); break;
      }
    };
    worker.postMessage({d:data,b:readtype,t:'xlsx'});
  }

  var last_wb;

  function to_json(workbook) {
    if(useworker && workbook.SSF) XLSX.SSF.load_table(workbook.SSF);
    var result = {};
    workbook.SheetNames.forEach(function(sheetName) {
      var roa = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {raw:false, header:1});
      if(roa.length > 0) result[sheetName] = roa;
    });
    return result;
  }

  function choose_sheet(sheetidx) { process_wb(last_wb, sheetidx); }

  function process_wb(wb, sheetidx) {
    last_wb = wb;
    opts.on.wb(wb, sheetidx);
    var sheet = wb.SheetNames[sheetidx||0];
    var json = to_json(wb)[sheet];
    opts.on.sheet(json, wb.SheetNames, choose_sheet);
  }

  function handleDrop(e) {
    e.stopPropagation();
    e.preventDefault();
    if(pending) return opts.errors.pending();
    var files = e.dataTransfer.files;
    var i,f;
    for (i = 0, f = files[i]; i != files.length; ++i) {
      var reader = new FileReader();
      reader.onload = function(e) {
        var data = e.target.result;
        var readtype = {type: 'array' };
        function doit() {
          try {
            if(useworker) { sheetjsw(data, process_wb, readtype); return; }
            var wb = XLSX.read(data, readtype);
            process_wb(wb);
          } catch(e) { console.log(e); opts.errors.failed(e); }
        }

        if(e.target.result.length > 1e6) opts.errors.large(e.target.result.length, function(e) { if(e) doit(); });
        else { doit(); }
      };
      reader.readAsArrayBuffer(f);
    }
  }

  function handleDragover(e) {
    e.stopPropagation();
    e.preventDefault();
    e.dataTransfer.dropEffect = 'copy';
  }

  if(opts.drop.addEventListener) {
    opts.drop.addEventListener('dragenter', handleDragover, false);
    opts.drop.addEventListener('dragover', handleDragover, false);
    opts.drop.addEventListener('drop', handleDrop, false);
  }

  function handleFile(e) {
    if(pending) return opts.errors.pending();
    var files = e.target.files;
    var i,f;
    for (i = 0, f = files[i]; i != files.length; ++i) {
      var reader = new FileReader();
      reader.onload = function(e) {
        var data = e.target.result;
        var readtype = {type: 'array' };
        function doit() {
          try {
            if(useworker) { sheetjsw(data, process_wb, readtype); return; }
            var wb = XLSX.read(data, readtype);
            process_wb(wb);
          } catch(e) { console.log(e); opts.errors.failed(e); }
        }

        if(e.target.result.length > 1e6) opts.errors.large(e.target.result.length, function(e) { if(e) doit(); });
        else { doit(); }
      };
      reader.readAsArrayBuffer(f);
    }
  }

  if(opts.file && opts.file.addEventListener) opts.file.addEventListener('change', handleFile, false);
};
</script>
    <script>
    /* oss.sheetjs.com (C) 2014-present SheetJS -- http://sheetjs.com */
/* vim: set ts=2: */

/** drop target **/
var _target = document.getElementById('drop');
var _file = document.getElementById('file');
var _grid = document.getElementById('grid');

/** Spinner **/
var spinner;

var _workstart = function() { spinner = new Spinner().spin(_target); }
var _workend = function() { spinner.stop(); }

/** Alerts **/
var _badfile = function() {
  console.log('This file does not appear to be a valid Excel file.  If we made a mistake, please report this issue to <a href="https://git.sheetjs.com/sheetjs/sheetjs/issues/">our bug tracker</a> so we can take a look.');
};

var _pending = function() {
  console.log('Please wait until the current file is processed.');
};

var _large = function(len, cb) {
  console.log("This file is " + len + " bytes and may take a few moments.  Your browser may lock up during this process.  Shall we play?");
};

var _failed = function(e) {
  console.log(e, e.stack);
};

/* make the buttons for the sheets */
var make_buttons = function(sheetnames, cb) {
  var buttons = document.getElementById('buttons');
  buttons.innerHTML = "";
  sheetnames.forEach(function(s,idx) {
    var btn = document.createElement('button');
    btn.type = 'button';
    btn.name = 'btn' + idx;
    btn.text = s;
    var txt = document.createElement('h3'); txt.innerText = s; btn.appendChild(txt);
    btn.addEventListener('click', function() { cb(idx); }, false);
    buttons.appendChild(btn);
    buttons.appendChild(document.createElement('br'));
  });
};

var cdg = canvasDatagrid({
  parentNode: _grid
});
cdg.style.height = '100%';
cdg.style.width = '100%';

function _resize() {
  _grid.style.height = (window.innerHeight - 200) + "px";
  _grid.style.width = (window.innerWidth - 200) + "px";
}
window.addEventListener('resize', _resize);

var _onsheet = function(json, sheetnames, select_sheet_cb) {
  document.getElementById('footnote').style.display = "none";

  make_buttons(sheetnames, select_sheet_cb);

  /* show grid */
  _grid.style.display = "block";
  _resize();

  /* set up table headers */
  var L = 0;
  json.forEach(function(r) { if(L < r.length) L = r.length; });
  console.log(L);
  for(var i = json[0].length; i < L; ++i) {
    json[0][i] = "";
  }

  /* load data */
  cdg.data = json;
};

/** Drop it like it's hot **/
DropSheet({
  file: _file,
  drop: _target,
  on: {
    workstart: _workstart,
    workend: _workend,
    sheet: _onsheet,
    foo: 'bar'
  },
  errors: {
    badfile: _badfile,
    pending: _pending,
    failed: _failed,
    large: _large,
    foo: 'bar'
  }
})

    </script>

    <script src="http://fgnass.github.io/spin.js/spin.js"></script>
  </body>
</html>
